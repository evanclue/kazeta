#! /bin/bash

# ensure inputplumber manages all controllers
for i in $(seq 1 100); do
        inputplumber devices manage-all --enable

        if [ "$?" == "0" ]; then
                break
        fi

        sleep 0.1
done

# hack to fix bios app audio
wpctl status > /dev/null

# start session
mv /var/kazeta/session.log /var/kazeta/session.log.old
/usr/bin/kazeta > /var/kazeta/session.log 2>&1 &

# default to using HDMI audio output and set a reasonable volume
if [ ! -e /var/kazeta/state/wireplumber ]; then
	mkdir -p /var/kazeta/state/wireplumber

	for i in $(seq 1 60); do
		sink_id=$(wpctl status --name | grep output | grep hdmi | head -1 | grep -oE " [0-9]+\. " | tr -d ' .')
		wpctl set-default $sink_id

		if [ "$?" == "0" ]; then
			wpctl set-volume $sink_id 0.8
			break
		fi

		sleep 1
	done
fi

wait

POWER_OFF=1
RESTART_SESSION_SENTINEL=/var/kazeta/state/.RESTART_SESSION_SENTINEL
if [ -f $RESTART_SESSION_SENTINEL ]; then
	rm -f $RESTART_SESSION_SENTINEL
	POWER_OFF=0
fi

if [ "$POWER_OFF" == "1" ]; then
	poweroff
fi
